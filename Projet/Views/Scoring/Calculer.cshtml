@model List<Projet.Models.CandidateMatchViewModel>

@{
    ViewData["Title"] = "Rapport de Matching";
}

<div class="container py-5">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h5 class="text-uppercase text-muted fw-bold small mb-1"><i class="fas fa-chart-pie me-2"></i>Rapport d'analyse</h5>
            <h2 class="fw-bold text-dark mb-0">@ViewBag.TitreOffre</h2>
            <p class="text-muted small">Algorithme déterministe v1.0 • @Model.Count profil(s) analysé(s)</p>
        </div>
        <div class="d-flex gap-2">
            <button onclick="window.print()" class="btn btn-light border shadow-sm"><i class="fas fa-print me-2"></i>Imprimer</button>
            <a asp-action="Index" class="btn btn-primary-gradient shadow-sm"><i class="fas fa-undo me-2"></i>Nouvelle analyse</a>
        </div>
    </div>

    <div class="card shadow border-0 overflow-hidden">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-4 text-secondary text-uppercase small fw-bold">Rang</th>
                        <th class="text-secondary text-uppercase small fw-bold">Candidat</th>
                        <th class="text-secondary text-uppercase small fw-bold" style="width: 30%;">Points Clés (Analyse)</th>
                        <th class="text-secondary text-uppercase small fw-bold" style="width: 20%;">Détails du Score</th>
                        <th class="text-center text-secondary text-uppercase small fw-bold">Note Finale</th>
                        <th class="text-end pe-4 text-secondary text-uppercase small fw-bold">Action</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        int rang = 1;
                    }
                    @foreach (var candidat in Model)
                    {
                        
                        string badgeClass = "bg-danger"; 
                        string rowClass = "";

                        if (candidat.ScoreGlobal >= 80)
                        {
                            badgeClass = "bg-success"; 
                            rowClass = "bg-success bg-opacity-10";
                        }
                        else if (candidat.ScoreGlobal >= 50)
                        {
                            badgeClass = "bg-warning text-dark"; 
                            rowClass = "";
                        }

                        
                        if (rang == 1) { rowClass += " border-start border-5 border-success"; }

                        <tr class="@(rang == 1 ? "bg-light" : "")">

                            <td class="ps-4">
                                <div class="rounded-circle bg-white border d-flex align-items-center justify-content-center fw-bold text-secondary shadow-sm"
                                     style="width: 32px; height: 32px;">
                                    @rang
                                </div>
                            </td>

                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="rounded-circle d-flex align-items-center justify-content-center me-3 fw-bold text-white shadow-sm"
                                         style="width: 45px; height: 45px; background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);">
                                        @candidat.NomComplet.Substring(0, 1)
                                    </div>
                                    <div>
                                        <div class="fw-bold text-dark">@candidat.NomComplet</div>
                                        <div class="small text-muted"><i class="fas fa-map-marker-alt me-1"></i> @candidat.JobActuel</div>
                                    </div>
                                </div>
                            </td>

                            <td>
                                <div class="d-flex flex-column gap-1">
                                    @foreach (var plus in candidat.DetailsPositifs.Take(2))
                                    {
                                        <div class="small text-success fw-bold">
                                            <i class="fas fa-check-circle me-1"></i> @plus
                                        </div>
                                    }
                                    @foreach (var minus in candidat.DetailsNegatifs.Take(2))
                                    {
                                        <div class="small text-danger">
                                            <i class="fas fa-times-circle me-1"></i> @minus
                                        </div>
                                    }

                                    @if (candidat.DetailsNegatifs.Count > 2 || candidat.DetailsPositifs.Count > 2)
                                    {
                                        <small class="text-muted fst-italic" style="font-size: 0.75rem;">+ autres critères...</small>
                                    }
                                </div>
                            </td>

                            <td>
                                <div class="d-flex align-items-center mb-1">
                                    <small class="text-muted fw-bold me-2" style="width: 45px; font-size: 0.7rem;">TECH</small>
                                    <div class="progress flex-grow-1" style="height: 6px; border-radius: 10px;">
                                        <div class="progress-bar bg-info" role="progressbar" style="width: @candidat.ScoreCompetences%"></div>
                                    </div>
                                    <small class="ms-2 text-muted" style="font-size: 0.7rem;">@candidat.ScoreCompetences%</small>
                                </div>

                                <div class="d-flex align-items-center mb-1">
                                    <small class="text-muted fw-bold me-2" style="width: 45px; font-size: 0.7rem;">EXP</small>
                                    <div class="progress flex-grow-1" style="height: 6px; border-radius: 10px;">
                                        <div class="progress-bar bg-warning" role="progressbar" style="width: @candidat.ScoreExperience%"></div>
                                    </div>
                                    <small class="ms-2 text-muted" style="font-size: 0.7rem;">@candidat.ScoreExperience%</small>
                                </div>

                                <div class="d-flex align-items-center">
                                    <small class="text-muted fw-bold me-2" style="width: 45px; font-size: 0.7rem;">LOC</small>
                                    <div class="progress flex-grow-1" style="height: 6px; border-radius: 10px;">
                                        <div class="progress-bar bg-secondary" role="progressbar" style="width: @candidat.ScoreLocalisation%"></div>
                                    </div>
                                    <small class="ms-2 text-muted" style="font-size: 0.7rem;">@candidat.ScoreLocalisation%</small>
                                </div>
                            </td>

                            <td class="text-center">
                                <div class="d-inline-block text-center">
                                    <span class="badge @badgeClass rounded-pill px-3 py-2 shadow-sm mb-1" style="font-size: 1.1rem;">
                                        @candidat.ScoreGlobal / 100
                                    </span>

                                    @if (candidat.ScoreGlobal == 0)
                                    {
                                        <div class="text-danger fw-bold small text-uppercase" style="font-size: 0.65rem;">Disqualifié</div>
                                    }
                                    else if (candidat.ScoreGlobal >= 80)
                                    {
                                        <div class="text-success fw-bold small text-uppercase" style="font-size: 0.65rem;">Excellent</div>
                                    }
                                </div>
                            </td>

                            <td class="text-end pe-4">
                                <a asp-controller="Personnes" asp-action="Details" asp-route-id="@candidat.CandidatId"
                                   class="btn btn-sm btn-light border text-primary" title="Voir le profil complet">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </td>
                        </tr>
                        rang++;
                    }
                </tbody>
            </table>

            @if (Model.Count == 0)
            {
                <div class="text-center py-5">
                    <i class="fas fa-users-slash fa-3x text-muted mb-3 opacity-50"></i>
                    <h5 class="text-muted">Aucun candidat analysé.</h5>
                    <p class="small text-muted">Vérifiez que votre base de candidats n'est pas vide.</p>
                </div>
            }
        </div>
    </div>

    <div class="mt-4 d-flex gap-4 justify-content-center text-muted small">
        <div class="d-flex align-items-center"><span class="badge bg-success rounded-circle p-1 me-2"> </span> Match (>80%)</div>
        <div class="d-flex align-items-center"><span class="badge bg-warning rounded-circle p-1 me-2"> </span> Potentiel (50-79%)</div>
        <div class="d-flex align-items-center"><span class="badge bg-danger rounded-circle p-1 me-2"> </span> Faible (<50%)</div>
    </div>
</div>